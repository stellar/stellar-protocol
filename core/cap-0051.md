```
CAP: 0050
Title: Smart Contract Host Functionality: Secp256r1 Verification
Working Group:
    Owner: Leigh McCulloch <@leighmcculloch>
    Authors: Leigh McCulloch <@leighmcculloch>
    Consulted:
Status: Draft
Created: 2023-01-30
Discussion: https://discord.com/channels/897514728459468821/1199160204676300841
Protocol version: TBD
```

## Simple Summary

Support secp256r1 verification in Soroban contracts via the exported host
interface.

## Motivation

Secp256r1, also commonly known as prime256r1 or ecdsa p256, is one of the most
common elliptic curve's used with ecdsa. It's the most common signature form
used in webauthn, which is the technology/standard behind passkeys available on,
browsers, computers, and phones. Supporting secp256r1 natively would allow for
the execution of efficient webauthn implementations where-by browsers,
computers, and phones could be the signers of accounts on Stellar via Soroban's
custom account interface. While it is possible to embed this logic into
contracts on the guest side, the execution cost of ecdsa verification is greater
than the networks current maximum limits.

### Goals Alignment

This CAP is aligned with the following Stellar Network Goals:

- The Stellar Network should make it easy for developers of Stellar projects to
  create highly usable products

## Abstract

**Note: The intent is for this proposal to be updated to hopefully only require
adding one of these functions, probably the recovery variety for consistency
with the existing crypto library support in Soroban. But until I finish
prototyping an actual use case with webauthn, I'm not confident if we need the
second or not.**

Two functions are added to the Soroban environment's exported interface:

1. `recovery_key_ecdsa_secp256r1` â€“ Much like the existing
`recovery_key_ecdsa_secp256k1` the function accepts a prehashed message,
signature, and recovery ID, and returns the public key used to sign the message.

2. `verify_ecdsa_secp256r1` - Much like the existing `verify_sig_ed25519` the
function accepts a public key, message, and signature, and returns only if the
signature is valid for the given public key. If the signature is not valid, the
function never returns and the current contract invocation (or sub-invocation)
traps.

## Specification

### XDR Changes

None.

### Host Function Changes

```diff mddiffcheck.base=v20.1.0
diff --git a/soroban-env-common/env.json b/soroban-env-common/env.json
index df7d5c4..0b7ecce 100644
--- a/soroban-env-common/env.json
+++ b/soroban-env-common/env.json
@@ -1958,6 +1958,46 @@
           ],
           "return": "BytesObject",
           "docs": "Recovers the SEC-1-encoded ECDSA secp256k1 public key that produced a given 64-byte signature over a given 32-byte message digest, for a given recovery_id byte."
+        },
+        {
+          "export": "3",
+          "name": "recovery_key_ecdsa_secp256r1",
+          "args": [
+            {
+              "name": "msg_digest",
+              "type": "BytesObject"
+            },
+            {
+              "name": "signature",
+              "type": "BytesObject"
+            },
+            {
+              "name": "recovery_id",
+              "type": "U32Val"
+            }
+          ],
+          "return": "BytesObject",
+          "docs": "Recovers the SEC-1-encoded ECDSA secp256r1 public key that produced a given 64-byte signature over a given 32-byte message digest, for a given recovery_id byte."
+        },
+        {
+          "export": "4",
+          "name": "verify_sig_ecdsa_secp256r1",
+          "args": [
+            {
+              "name": "key",
+              "type": "BytesObject"
+            },
+            {
+              "name": "msg",
+              "type": "BytesObject"
+            },
+            {
+              "name": "sig",
+              "type": "BytesObject"
+            }
+          ],
+          "return": "BytesObject",
+          "docs": "Verifies the SEC-1-encoded ECDSA secp256r1 public key produced a given 64-byte signature over a given 32-byte message digest."
         }
       ]
     },
```

### Semantics

#### Host Function Changes

TODO:
- Why recovery variant? For consistency with the edcda secp256k1 interface.
- Why verify variant? Because secp256r1 is less commonly used in applications
where recovery IDs are provided and more commonly the public key is known. It's
not yet clear to me how easy it is for an application developer, without
potentially making a detrimental error, might be able to adapt one to the other.
As such it may be safer to provide the verify interface.

## Protocol Upgrade Transition

### Backwards Incompatibilities

This proposal is completely backwards compatible.

### Resource Utilization

TODO

## Test Cases

None yet.

## Implementation

None yet. But will be tracked by [stellar/rs-sorovan-env#807] if implemented.

[stellar/rs-soroban-env]: (https://github.com/stellar/rs-soroban-env/issues/807)
